! Sample Configuration File for keepalived vrrp instances
! Generated by Chef.

<% if node.keepalived.smtp_server %>
global_defs {
   notification_email {
     <% node.keepalived.notification_emails.each do |email| %>
        <%= email %> 
     <% end %>
   }
   notification_email_from <%= node.keepalived.notification_email_from %>
   smtp_server <%= node.keepalived.smtp_server %>
   smtp_connect_timeout <%= node.keepalived.smtp_connect_timeout %>
   router_id LVS_DEVEL
}
<% end %>

<% node.keepalived.vrrp_instances.each do |instance| %>
vrrp_instance <%= instance["name"] %> {
    interface <%= instance["interface"] %>
    state <%= (instance["backup_nodes"].include? node.name) ? "BACKUP" : "MASTER" %>
    virtual_router_id <%= instance["virtual_router_id"] %>
    <% if instance["nopreempt"] %>nopreempt<% end %>
    priority <%= (instance["backup_nodes"].include? node.name) ? instance["backup_priority"] : instance["master_priority"] %> 
    <% if instance["advert_int"] %>advert_int <%= instance["advert_int"] %><%end%>
    <% if node.keepalived.smtp_server %>smtp_alert<% end %>
    virtual_ipaddress {
    <% instance["virtual_ipaddress"].each do |addr| %>
        <%= addr %>
    <% end %>
    }
    <% if instance["track_script"] %>
    track_script {
        <%= instance["track_script"]["name"] %>
    }
    <% end %>

    <% if instance["notify_scripts"] && (not instance["notify_scripts"].empty?) %>
    <% instance["notify_scripts"].each do |state, info| %>
    notify_<%= state -%> /etc/keepalived/scripts/<%= instance["name"] -%>/notify_<%= state -%>.sh
    <% end %>
    <% end %>
}

<%# Include any track sripts for this instance %>
<% if instance["track_script"] %>
vrrp_script <%= instance["track_script"]["name"] %> {
    script   "<%= instance["track_script"]["script"] %>"
    interval <%= instance["track_script"]["interval"] %> 
    weight   <%= instance["track_script"]["weight"] %> 
}
<% end %>

<% end %>

